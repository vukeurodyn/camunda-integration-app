services:
  camunda:
    build: ./camunda  # ‚Üê Changed from "image: camunda/camunda-bpm-platform:run-latest"
    container_name: camunda
    ports:
      - "9091:8080"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/engine-rest/version"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  mailpit:
    image: axllent/mailpit:latest
    container_name: mailpit
    ports:
      - "8025:8025"
      - "1025:1025"
    restart: unless-stopped

  worker:
    build: .
    container_name: worker
    depends_on:
      camunda:
        condition: service_healthy
      mailpit:
        condition: service_started
    environment:
      CAMUNDA_REST_BASE_URL: http://camunda:8080/engine-rest
      MAIL_HOST: mailpit
      MAIL_PORT: 1025
      MAIL_FROM: noreply@local.test
      SERVER_PORT: 8080
      KC_TOKEN_URL: https://circuloos-platform.eurodyn.com/idm/realms/fiware-server/protocol/openid-connect/token
      KC_CLIENT_ID: orion-pep
      KC_CLIENT_SECRET: changeme
      ORION_BASE_URL: https://circuloos-platform.eurodyn.com/kong/keycloak-orion
    ports:
      - "9092:8080"
    restart: unless-stopped